<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="tab.css">
  </head>

  <body>
    <div class="login-container" style="display:none" data-bind="visible: !showError()">
      <div class="section-caption">Login</div>

      <!-- (!logged in) Login button -->
      <button type="button"
              style="display:none"
              data-bind="click: login, visible: !userName() && showLoginButton()"
              class="ts-btn ts-btn-primary">Log in with Trello</button>

      <!-- (logged in) Login information -->
      <div style="display:none" data-bind="visible: userName()">
        Logged in as <span data-bind="text: userName"></span> <a href="javascript:void(0)" data-bind="click: logout" class="logout-link">Log out</a>
      </div>
    </div>

    <!-- (error) Error message -->
    <div class="error-container" style="display:none" data-bind="visible: showError()">
      <img src="error_generic.png" class="error-img"/>
      <div class="error-title">That's weird...</div>
      <div class="error-subtitle">We're having trouble loading your Trello boards right now.</div>
      <button type="button" class="ts-btn ts-btn-primary" data-bind="click: fetchData">Try again</button>
    </div>

    <div class="boards-container" data-bind="visible: userName() && !showError()">
      <div class="section-caption">Select board</div>

      <!-- (logged in) Boards list -->
      <div style="display:none" data-bind="visible: userName()">
        <!-- Starred boards -->
        <div class="board-group">
          <div class="board-group-caption">Starred boards</div>
          <ul data-bind="foreach: starredBoardsList">
            <li data-bind="click: $root.selectBoard, css:{ selected: selected }" class="board-list-item">
              <span class="board-list-item-background" data-bind="style:{ backgroundColor : backgroundColor, backgroundImage: backgroundImage }"></span>
              <span class="board-list-item-fade"></span>
              <div class="board-data-container">
                <div class="board-thumbnail" data-bind="style:{ backgroundColor : backgroundColor, backgroundImage: backgroundImage }"></div>
                <div class="board-data">
                  <div data-bind="text: name" class="board-name"></div>
                  <div class="board-team-name" data-bind="visible: team, text: team"></div>
                </div>
              </div>
            </li>
          </ul>
        </div>
        <!-- Personal boards -->
        <div class="board-group">
          <div class="board-group-caption">Personal boards</div>
          <ul data-bind="foreach: personalBoardsList">
            <li data-bind="click: $root.selectBoard, css:{ selected: selected }" class="board-list-item">
              <span class="board-list-item-background" data-bind="style:{ backgroundColor : backgroundColor, backgroundImage: backgroundImage }"></span>
              <span class="board-list-item-fade"></span>
              <div class="board-data-container">
                <div class="board-thumbnail" data-bind="style:{ backgroundColor : backgroundColor, backgroundImage: backgroundImage }"></div>
                <div class="board-data">
                  <div data-bind="text: name" class="board-name"></div>
                </div>
              </div>
            </li>
          </ul>
        </div>
        <!-- Team boards -->
        <div data-bind="foreach: teamBoardsSections" class="board-group">
          <div class="board-group">
            <div class="board-group-caption" data-bind="text: team"></div>
            <ul data-bind="foreach: boards">
              <li data-bind="click: $root.selectBoard, css:{ selected: selected }" class="board-list-item">
                <span class="board-list-item-background" data-bind="style:{ backgroundColor : backgroundColor, backgroundImage: backgroundImage }"></span>
                <span class="board-list-item-fade"></span>
                <div class="board-data-container">
                  <div class="board-thumbnail" data-bind="style:{ backgroundColor : backgroundColor, backgroundImage: backgroundImage }"></div>
                  <div class="board-data">
                    <div data-bind="text: name" class="board-name"></div>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.1/knockout-min.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.1.1.min.js"></script>
    <script src="https://statics.teams.microsoft.com/sdk/v0.5/js/MicrosoftTeams.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    <script src="https://api.trello.com/1/client.js?key=80829e2253ed135452eac9e91b9c2684"></script>

    <script type="text/javascript">
      microsoftTeams.initialize();

      // Parse query parameters
      let queryParams = {};
      location.search.substr(1).split("&").forEach(function(item) {
        let s = item.split("="),
          k = s[0],
          v = s[1] && decodeURIComponent(s[1]);
        queryParams[k] = v;
      });

      // Set CSS class for theme
      let themeParam = queryParams["theme"];
      if (themeParam && (themeParam === "dark" || themeParam === "contrast")) {
        let bodyElement = document.getElementsByTagName("body")[0];
        bodyElement.className += " theme-" + themeParam;
      }

      // View model for board item
      function BoardListItemViewModel(board) {
        let self = this;

        self.selected = ko.observable(false);

        self.id = board.id;
        self.url = board.url;
        self.name = board.name;
        self.team = board.organization ? board.organization.displayName : "";
        self.backgroundColor = board.prefs.backgroundColor ? board.prefs.backgroundColor : null;

        if (board.prefs.backgroundImage) {
          // Pick the smallest scaled image available
          if (board.prefs.backgroundImageScaled && board.prefs.backgroundImageScaled.length) {
            let sortedScaledImages = _.sortBy(board.prefs.backgroundImageScaled, "height");
            self.backgroundImage = "url('" + sortedScaledImages[0].url + "')";
          } else {
            self.backgroundImage = "url('" + board.prefs.backgroundImage + "')";
          }
        } else {
          self.backgroundImage = null;
        }
      }

      // View model for this screen
      function TabConfigurationViewModel() {
        let self = this;

        self.selectedBoard = null;

        // Binding properties
        self.showLoginButton = ko.observable(false);
        self.showError = ko.observable(false);
        self.userName = ko.observable(null);
        self.starredBoardsList = ko.observableArray([]);
        self.personalBoardsList = ko.observableArray([]);
        self.teamBoardsSections = ko.observableArray([]);

        // Initiate Trello signin flow
        // See https://msdn.microsoft.com/en-us/microsoft-teams/auth
        self.login = function() {
          microsoftTeams.authentication.authenticate({
            url: "tab-config-login.html",
            height: 655,
            successCallback: function() {
              Trello.authorize({
                persist: true,
                interactive: false,
                success: function() {
                  self.fetchData();
                }
              });
            },
            failureCallback: function() {
              self.userName(null);
              self.showLoginButton(true);
            }});
        }

        // Sign out from Trello
        self.logout = function() {
          // Delete the token, if we have one
          let token = Trello.token();
          if (token) {
            Trello.del("/tokens/" + token);
          }
          Trello.deauthorize();

          // Reset state
          self.showLoginButton(true);
          self.showError(false);
          self.userName(null);
          self.starredBoardsList([]);
          self.personalBoardsList([]);
          self.teamBoardsSections([]);
        }

        // Fetch user name and board list
        self.fetchData = function() {
          Trello.get("/member/me?boards=open,starred&board_fields=name,idOrganization,starred,prefs,url,dateLastActivity&board_organization=true&boardStars=true&organizations=all&organization_fields=name,displayName",
            function (memberData) {
              let boards = memberData.boards || [];

              // Create starred boards section
              let starredBoards = _.chain(memberData.boardStars || [])
                  .sortBy("pos")
                  .map(function (boardStar) {
                      return _.find(boards, function (board) { return (board.id === boardStar.idBoard); });
                  })
                  .filter(function (board) { return board; })
                  .map(function (board) { return new BoardListItemViewModel(board); })
                  .value();
              if (starredBoards && starredBoards.length) {
                self.starredBoardsList(starredBoards);
              }

              // Create personal boards section
              let personalBoards = _.chain(boards)
                  .reject(function (b) { return b.organization; })
                  .sortBy("dateLastActivity")
                  .reverse()
                  .sortBy(function (b) { return b.name.toLocaleUpperCase(); })
                  .map(function (board) { return new BoardListItemViewModel(board); })
                  .value();
              if (personalBoards && personalBoards.length) {
                self.personalBoardsList(personalBoards);
              }

              // Create team board sections
              let boardsByTeam = _.chain(memberData.organizations || [])
                  .sortBy(function (organization) { return organization.displayName.toLocaleUpperCase(); })
                  .map(function (organization) {
                      return {
                        team: organization.displayName,
                        boards: _.chain(boards)
                          .filter(function (board) { return (board.idOrganization === organization.id); })
                          .map(function (board) { return new BoardListItemViewModel(board); })
                          .value()
                      };
                  })
                  .value();
              self.teamBoardsSections(boardsByTeam);

              self.userName(memberData.fullName + " (" + memberData.username + ")");
              self.showError(false);
            },
            function (error) {
              console.error(error);
              if (error.status === 401) {
                // Unauthorized: delete stored token and show login button
                Trello.deauthorize();
                self.showLoginButton(true);
                self.showError(false);
              } else {
                self.showError(true);
              }
            });
        }

        // Select a board
        self.selectBoard = function(boardItem) {
          // Unselect the last item, and select this one
          if (self.selectedBoard) {
            self.selectedBoard.selected(false);
          }
          self.selectedBoard = boardItem;
          boardItem.selected(true);

          // Register the save handler and allow saving
          let tabContentPageUrl = window.location.origin + "/tab/tab-content.html";
          microsoftTeams.settings.registerOnSaveHandler(function(saveEvent) {
            microsoftTeams.settings.setSettings({
              entityId: boardItem.id,
              contentUrl: tabContentPageUrl + "?contentUrl=" + encodeURIComponent(boardItem.url),
              suggestedTabName: boardItem.name,
              websiteUrl: boardItem.url,
            });
            saveEvent.notifySuccess();
          });
          microsoftTeams.settings.setValidityState(true);
        }

        // Initial check if we have a token for Trello
        Trello.authorize({
          persist: true,
          interactive: false,
          success: function() {
            self.fetchData();
          },
          error: function() {
            self.showLoginButton(true);
          }
        });
      }

      ko.applyBindings(new TabConfigurationViewModel());
    </script>
  </body>
</html>
